<html>
  <head>
    <title>jstree treegrid plugin demo</title>
    <script type='text/javascript' src='jquery-min.js'></script>
    <script type="text/javascript" src="jquery.jstree.js"></script>
    <script type="text/javascript" src="jstreegrid.js"></script>
    <script type="text/javascript">
      var eXportN = null, eXportD = null, eXportR = null;
      $(document).ready(function(){
        var data, xmldata;

        /*
         * Do the JSON tree from Card url
         */

        $("div#jstree").bind("loaded_grid.jstree",function(){
          $("span#status").text("loaded");
        });
        $("div#jstree").jstree({
          plugins: ["themes","json_data","grid","dnd"],
          json_data: {ajax:{
            url: '/a_test_form.json?view=content',
            data: function(node) {
              eXportN = node;
              console.log('node in data '+node)
              },
            success: function (data) {
              eXportD = data; 
              var attrs = data.card.attr,
                  cardName = attrs.key,
                  chldrn = data.card.content,
                  modelHash = { };
              chldrn.forEach(function (chld) {
                if (typeof chld != 'string') {
                  eXportR = chld
                  console.log('card? '+chld)
                  if (chld.card != null) { chld = chld.card; }
                  console.log('each '+chld)
                  eXportR = chld.attr
                  modelHash[chld.attr.name] = chld.content
                  chld.data = chld.attr.key;
                  //chld.attr = 
                }
                })
              eXportR = {
                data: cardName,
                state: 'closed',
                attr: modelHash,
              };
              return eXportR;
              /*
              var attrs = data.card.attr
              var chldrn = data.card.content.cards
              chldrn.forEach(function (chld) { chld.data = chld.attr.key; })
              eXportR = {
                data: attrs.key,
                state: 'open',
                attr: {
                  name: attrs.name,
                  type: attrs.type
                },
                children: chldrn
              };
              return eXportR;
              */
            }
          }},
          grid: {
            columns: [
              {width: 240, header: "Nodes",title:"_DATA_"},
              {cellClass: "col1", value: "name", width: 200, header: "Full Name", title: "name"},
              {cellClass: "col2", value: "address", width: 200, header: "Address", title: "address"},
              {cellClass: "col3", value: "city", width: 100, header: "City", title: "city"},
              {cellClass: "col4", value: "state", width: 30, header: "St", title: "state"},
              {cellClass: "col5", value: "zip", width: 100, header: "Zipcode", title: "zipcode"}
            ],
            resizable:true
          },
          dnd: {
            drop_finish : function () {
            },
            drag_finish : function () {
            },
            drag_check : function (data) {
              return { after : true, before : true, inside : true };
            }
          }
        });
        $("a#change").click(function(){
          var li = $("li:eq(0)","div#jstree"), val = li.attr("size"), newval = parseInt(val,10)*2;
          li.attr("size",newval).trigger("change_node.jstree");
        });


        /*
         * Do the XML tree (html part removed to disable this for now)
         */
        xmldata =
            '<root>'+
              '<item id="xml_root_1" price="$5.00" size="4">'+
                '<content><name>Root 1</name></content>'+
                '<item id="xml_child_1" price="$4.00" size="3">'+
                  '<content><name>Really long named child whose name gets cut off</name></content>'+
                '</item>'+
                '<item id="xml_child_2" price="$3.00" size="2">'+
                  '<content><name>Child 2</name></content>'+
                '</item>'+
              '</item>'+
            '</root>';
        $("div#jstreex").bind("loaded_grid.jstree",function(){
          $("span#xstatus").text("loaded");
        });
        $("div#jstreex").jstree({
          plugins: ["themes","xml_data","grid","dnd"],
          xml_data: {data: xmldata, xsl: "nest",clean_node:true},
          grid: {
            columns: [
              {width: 110, header: "Nodes",title:"_DATA_"},
              {cellClass: "col1", value: "price", width: 60, header: "Price", title:"price"},
              {cellClass: "col2", value: "size", width: 60, header: "Qty", title:"size"}
            ]
          },
          dnd: {
            drop_finish : function () { },
            drag_finish : function () { },
            drag_check : function (data) {
              return { after : true, before : true, inside : true };
            }
          }
        });

      });
    </script>
  </head>
  <body>
    <h2>Tree Grid Demo</h2>
    This page gives a demo for using the excellent <a href="http://www.jstree.com">jstree</a>, built on the
    amazing <a href="http://jquery.com">jQuery</a> library, with a tree grid. The treegrid is implemented
    as a standard jstree plugin. Simply include jquery and jstree, and the plugin library jstreegrid.js,
    and include it as a plugin. Look at the source to this page to see how it is done.
    <p/>
    Some interesting feature usage. Check out the HTML and JS config to see the details:
    <ul>
      <li>The XML tree has a max-height set to 30px, causing the tree itself - but not the headers - to scroll.</li>
      <li>The JSON tree has resizable columns, set to true.</li>
    </ul>
    <div id="json_jstree">
      <h4>JSON Tree</h4>
      <div id="jstree"></div>
      <div>Tree grid is <span id="status">loading</span>.</div>
      <div><a href="#" id="change">Click here to double the root Qty</a></div>
    </div>
  </body>
</html>

